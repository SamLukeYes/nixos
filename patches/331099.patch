From af91b17569bb0e45c8baf1533399e607a2ce989b Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 18:05:33 +0300
Subject: [PATCH 1/8] sequoia-wot: small 'with lib;' removal

---
 pkgs/by-name/se/sequoia-wot/package.nix | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/pkgs/by-name/se/sequoia-wot/package.nix b/pkgs/by-name/se/sequoia-wot/package.nix
index 38c90c4837fda5..560b8a3de81b30 100644
--- a/pkgs/by-name/se/sequoia-wot/package.nix
+++ b/pkgs/by-name/se/sequoia-wot/package.nix
@@ -80,11 +80,11 @@ rustPlatform.buildRustPackage rec {
       target/*/release/build/sequoia-wot-*/out/sq-wot-path.1
   '';
 
-  meta = with lib; {
+  meta = {
     description = "Rust CLI tool for authenticating bindings and exploring a web of trust";
     homepage = "https://gitlab.com/sequoia-pgp/sequoia-wot";
-    license = licenses.gpl2Only;
-    maintainers = with maintainers; [ Cryolitia ];
+    license = lib.licenses.gpl2Only;
+    maintainers = with lib.maintainers; [ Cryolitia ];
     mainProgram = "sq-wot";
   };
 }

From 822739021d465d6f7f36d11cc3b9422da6d199fc Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 18:05:51 +0300
Subject: [PATCH 2/8] sequoia-wot: add doronbehar to maintainers

---
 pkgs/by-name/se/sequoia-wot/package.nix | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/pkgs/by-name/se/sequoia-wot/package.nix b/pkgs/by-name/se/sequoia-wot/package.nix
index 560b8a3de81b30..00bc28f9754185 100644
--- a/pkgs/by-name/se/sequoia-wot/package.nix
+++ b/pkgs/by-name/se/sequoia-wot/package.nix
@@ -84,7 +84,7 @@ rustPlatform.buildRustPackage rec {
     description = "Rust CLI tool for authenticating bindings and exploring a web of trust";
     homepage = "https://gitlab.com/sequoia-pgp/sequoia-wot";
     license = lib.licenses.gpl2Only;
-    maintainers = with lib.maintainers; [ Cryolitia ];
+    maintainers = with lib.maintainers; [ doronbehar Cryolitia ];
     mainProgram = "sq-wot";
   };
 }

From 39ecfa62730a4e4bc1253e2c6f2b1b9f0346238d Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 18:05:10 +0300
Subject: [PATCH 3/8] sequoia-sqv: small 'with lib;' removal

---
 pkgs/tools/security/sequoia-sqv/default.nix | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/pkgs/tools/security/sequoia-sqv/default.nix b/pkgs/tools/security/sequoia-sqv/default.nix
index 7923b494c17e41..d2c4a85c717eb4 100644
--- a/pkgs/tools/security/sequoia-sqv/default.nix
+++ b/pkgs/tools/security/sequoia-sqv/default.nix
@@ -50,11 +50,11 @@ rustPlatform.buildRustPackage rec {
 
   passthru.updateScript = nix-update-script { };
 
-  meta = with lib; {
+  meta = {
     description = "Command-line OpenPGP signature verification tool";
     homepage = "https://docs.sequoia-pgp.org/sqv/";
-    license = licenses.gpl2Plus;
-    maintainers = with maintainers; [ doronbehar ];
+    license = lib.licenses.gpl2Plus;
+    maintainers = with lib.maintainers; [ doronbehar ];
     mainProgram = "sqv";
   };
 }

From 5ef5b3e8570fc00ef9910a89b41ab19e7360abe9 Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 18:06:26 +0300
Subject: [PATCH 4/8] sequoia-sq: cleanup: 'with lib;', outdated comment

The git blame of the comment pointed to a workaround irrelevant anymore.
---
 pkgs/by-name/se/sequoia-sq/package.nix | 7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

diff --git a/pkgs/by-name/se/sequoia-sq/package.nix b/pkgs/by-name/se/sequoia-sq/package.nix
index 1df73c9cd3f245..0c7f57600c5215 100644
--- a/pkgs/by-name/se/sequoia-sq/package.nix
+++ b/pkgs/by-name/se/sequoia-sq/package.nix
@@ -47,7 +47,6 @@ rustPlatform.buildRustPackage rec {
     nettle
   ] ++ lib.optionals stdenv.isDarwin (with darwin.apple_sdk.frameworks; [ Security SystemConfiguration ]);
 
-  # Sometimes, tests fail on CI (ofborg) & hydra without this
   checkFlags = [
     # doctest for sequoia-ipc fail for some reason
     "--skip=macros::assert_send_and_sync"
@@ -69,12 +68,12 @@ rustPlatform.buildRustPackage rec {
 
   passthru.updateScript = nix-update-script { };
 
-  meta = with lib; {
+  meta = {
     description = "Cool new OpenPGP implementation";
     homepage = "https://sequoia-pgp.org/";
     changelog = "https://gitlab.com/sequoia-pgp/sequoia-sq/-/blob/v${version}/NEWS";
-    license = licenses.gpl2Plus;
-    maintainers = with maintainers; [ minijackson doronbehar ];
+    license = lib.licenses.gpl2Plus;
+    maintainers = with lib.maintainers; [ minijackson doronbehar ];
     mainProgram = "sq";
   };
 }

From 20b1291f06d5867e75fa3ad59fbca7149255798f Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 18:06:56 +0300
Subject: [PATCH 5/8] sequoia-sqop: small 'with lib;' removal

---
 pkgs/tools/security/sequoia-sqop/default.nix | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/pkgs/tools/security/sequoia-sqop/default.nix b/pkgs/tools/security/sequoia-sqop/default.nix
index 2354a63d973747..ff62b5793f0e55 100644
--- a/pkgs/tools/security/sequoia-sqop/default.nix
+++ b/pkgs/tools/security/sequoia-sqop/default.nix
@@ -48,11 +48,11 @@ rustPlatform.buildRustPackage rec {
 
   passthru.updateScript = nix-update-script { };
 
-  meta = with lib; {
+  meta = {
     description = "Implementation of the Stateless OpenPGP Command Line Interface using Sequoia";
     homepage = "https://docs.sequoia-pgp.org/sqop/";
-    license = licenses.gpl2Plus;
-    maintainers = with maintainers; [ doronbehar ];
+    license = lib.licenses.gpl2Plus;
+    maintainers = with lib.maintainers; [ doronbehar ];
     mainProgram = "sqop";
   };
 }

From d78a5e8eeeb7b31e1cb1edc805576d8617d76b86 Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 17:53:50 +0300
Subject: [PATCH 6/8] sequoia-wot: 0.11.0 -> 0.12.0

Diff: https://gitlab.com/sequoia-pgp/sequoia-wot/-/compare/v0.11.0...v0.12.0
---
 pkgs/by-name/se/sequoia-wot/package.nix | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/pkgs/by-name/se/sequoia-wot/package.nix b/pkgs/by-name/se/sequoia-wot/package.nix
index 00bc28f9754185..d95066972cb83a 100644
--- a/pkgs/by-name/se/sequoia-wot/package.nix
+++ b/pkgs/by-name/se/sequoia-wot/package.nix
@@ -13,16 +13,16 @@
 }:
 rustPlatform.buildRustPackage rec {
   pname = "sequoia-wot";
-  version = "0.11.0";
+  version = "0.12.0";
 
   src = fetchFromGitLab {
     owner = "sequoia-pgp";
     repo = "sequoia-wot";
     rev = "v${version}";
-    hash = "sha256-qSf2uESsMGUEvAiRefpwxHKyizbq5Sst3SpjKaMIWTQ=";
+    hash = "sha256-Xbj1XLZQxyEYf/+R5e6EJMmL0C5ohfwZMZPVK5PwmUU=";
   };
 
-  cargoHash = "sha256-vGseKdHqyncScS57UF3SR3EVdUGKVMue8fnRftefSY0=";
+  cargoHash = "sha256-BidSKnsIEEEU8UarbhqALcp44L0pes6O4m2mSEL1r4Q=";
 
   nativeBuildInputs = [
     pkg-config

From 16aba95671fcf03beaae3ecc41c79d0d2b6e19b6 Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 17:57:19 +0300
Subject: [PATCH 7/8] sequoia-sqv: 1.1.0 -> 1.2.1

---
 pkgs/tools/security/sequoia-sqv/default.nix | 29 +++++++++------------
 1 file changed, 13 insertions(+), 16 deletions(-)

diff --git a/pkgs/tools/security/sequoia-sqv/default.nix b/pkgs/tools/security/sequoia-sqv/default.nix
index d2c4a85c717eb4..591a547425ba2b 100644
--- a/pkgs/tools/security/sequoia-sqv/default.nix
+++ b/pkgs/tools/security/sequoia-sqv/default.nix
@@ -9,17 +9,16 @@
 
 rustPlatform.buildRustPackage rec {
   pname = "sequoia-sqv";
-  version = "1.1.0";
+  version = "1.2.1";
 
   src = fetchFromGitLab {
     owner = "sequoia-pgp";
     repo = "sequoia-sqv";
     rev = "v${version}";
-    hash = "sha256-KoB9YnPNE2aB5MW5G9r6Bk+1QnANVSKA2dp3ufSJ44M=";
+    hash = "sha256-frGukJDsxq+BWLPC/4imfc42lDKVF8BPIQQDazaLaQ0=";
   };
-  cargoPatches = [ ./Cargo.lock.patch ];
 
-  cargoHash = "sha256-E6tNOc3omg6yLwCP+MdyBF/HmFTBFCiXd5r+jflfs4k=";
+  cargoHash = "sha256-1h1nXtXMTwL8ICxWTV8My0IdE+6w0L7xXZD012Cv5U8=";
 
   nativeBuildInputs = [
     pkg-config
@@ -30,20 +29,18 @@ rustPlatform.buildRustPackage rec {
   buildInputs = [
     nettle
   ];
-  # Otherwise, the shell completion files are not built
-  cargoBuildFlags = [
-    "--package" "sequoia-sqv"
-  ];
-  # Use a predictable target directory, to access it when installing shell
-  # completion files.
-  preBuild = ''
-    export CARGO_TARGET_DIR="$(pwd)/target"
-  '';
+  # Install shell completion files and manual pages. Unfortunatly it is hard to
+  # predict the paths to all of these files generated during the build, and it
+  # is impossible to control these using `$OUT_DIR` or alike, as implied by
+  # upstream's `build.rs`. This is a general Rust issue also discussed in
+  # https://github.com/rust-lang/cargo/issues/9661, also discussed upstream at:
+  # https://gitlab.com/sequoia-pgp/sequoia-wot/-/issues/56
   postInstall = ''
+    installManPage target/*/release/build/*/out/man-pages/sqv.1
     installShellCompletion --cmd sqv \
-      --zsh target/_sqv \
-      --bash target/sqv.bash \
-      --fish target/sqv.fish
+      --zsh target/*/release/build/*/out/shell-completions/_sqv \
+      --bash target/*/release/build/*/out/shell-completions/sqv.bash \
+      --fish target/*/release/build/*/out/shell-completions/sqv.fish
   '';
 
   doCheck = true;

From 19a50c14829d923966fd47ea989f4f36901b1ae0 Mon Sep 17 00:00:00 2001
From: Doron Behar <doron.behar@gmail.com>
Date: Tue, 30 Jul 2024 17:53:27 +0300
Subject: [PATCH 8/8] sequoia-sq: 0.34.0 -> 0.37.0

Diff: https://gitlab.com/sequoia-pgp/sequoia-sq/-/compare/v0.34.0...v0.37.0

Changelog: https://gitlab.com/sequoia-pgp/sequoia-sq/-/blob/v0.37.0/NEWS

Tests that we skipped before are now removed. A different test is now
failing.
---
 pkgs/by-name/se/sequoia-sq/package.nix | 25 ++++++++++---------------
 1 file changed, 10 insertions(+), 15 deletions(-)

diff --git a/pkgs/by-name/se/sequoia-sq/package.nix b/pkgs/by-name/se/sequoia-sq/package.nix
index 0c7f57600c5215..4183e235286f7f 100644
--- a/pkgs/by-name/se/sequoia-sq/package.nix
+++ b/pkgs/by-name/se/sequoia-sq/package.nix
@@ -1,6 +1,5 @@
 { stdenv
 , fetchFromGitLab
-, fetchpatch
 , lib
 , darwin
 , nettle
@@ -15,24 +14,16 @@
 
 rustPlatform.buildRustPackage rec {
   pname = "sequoia-sq";
-  version = "0.34.0";
+  version = "0.37.0";
 
   src = fetchFromGitLab {
     owner = "sequoia-pgp";
     repo = "sequoia-sq";
     rev = "v${version}";
-    hash = "sha256-voFektWZnkmIQzI7s5nKzVVWQtEhzk2GKtxX926RtxU=";
+    hash = "sha256-D22ECJvbGbnyvusWXfU5F1aLF/ETuMyhAStT5HPWR2U=";
   };
-  patches = [
-    # Fixes test failing on Darwin, see:
-    # https://gitlab.com/sequoia-pgp/sequoia-sq/-/issues/211
-    (fetchpatch {
-      url = "https://gitlab.com/sequoia-pgp/sequoia-sq/-/commit/21221a935e0d058ed269ae6c8f45c5fa7ea0d598.patch";
-      hash = "sha256-ZjTl3EumeFwMJUl+qMpX+P2maYz4Ow/Tn9KwYbHDbes=";
-    })
-  ];
 
-  cargoHash = "sha256-3ncBpRi0v6g6wwPkSASDwt0d8cOOAUv9BwZaYvnif1U=";
+  cargoHash = "sha256-jFpqZKyRCMkMtOezsYJy3Fy1WXUPyn709wZxuwKlSYI=";
 
   nativeBuildInputs = [
     pkg-config
@@ -48,11 +39,15 @@ rustPlatform.buildRustPackage rec {
   ] ++ lib.optionals stdenv.isDarwin (with darwin.apple_sdk.frameworks; [ Security SystemConfiguration ]);
 
   checkFlags = [
-    # doctest for sequoia-ipc fail for some reason
-    "--skip=macros::assert_send_and_sync"
-    "--skip=macros::time_it"
+    # https://gitlab.com/sequoia-pgp/sequoia-sq/-/issues/297
+    "--skip=sq_autocrypt_import"
   ];
 
+  # Needed for tests to be able to create a ~/.local/share/sequoia directory
+  preCheck = ''
+    export HOME=$(mktemp -d)
+  '';
+
   env.ASSET_OUT_DIR = "/tmp/";
 
   doCheck = true;
