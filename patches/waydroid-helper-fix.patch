From 5c7c53b1e9e586d1370347038ef4fe4d6a181792 Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Tue, 29 Jul 2025 01:23:59 +0800
Subject: [PATCH 1/5] waydroid-helper: fix service paths

---
 pkgs/by-name/wa/waydroid-helper/package.nix | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/pkgs/by-name/wa/waydroid-helper/package.nix b/pkgs/by-name/wa/waydroid-helper/package.nix
index 42dd8bda565a71..3a6137c41ff2b3 100644
--- a/pkgs/by-name/wa/waydroid-helper/package.nix
+++ b/pkgs/by-name/wa/waydroid-helper/package.nix
@@ -38,7 +38,9 @@ python3Packages.buildPythonApplication rec {
       --replace-fail "dbus_service_dir," "'$out/share/dbus-1/system-services',"
     substituteInPlace systemd/meson.build \
       --replace-fail ": systemd_system_unit_dir" ": '$out/lib/systemd/system'" \
-      --replace-fail ": systemd_user_unit_dir" ": '$out/lib/sysusers.d'"
+      --replace-fail ": systemd_user_unit_dir" ": '$out/lib/systemd/user'"
+    substituteInPlace systemd/{system/waydroid-mount,user/waydroid-monitor}.service \
+      --replace-fail "/usr/bin/waydroid-helper" "$out/bin/waydroid-helper"
     # com.jaoushingan.WaydroidHelper.desktop: component-name-missing, description-first-para-too-short
     # url-homepage-missing, desktop-app-launchable-omitted, content-rating-missing, developer-info-missing
     sed -i '/test(/{N;/Validate appstream file/!b;:a;N;/)/!ba;d}' data/meson.build

From 6a099cf6004c3692f108c5f7e303d38760fd20cf Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Tue, 29 Jul 2025 01:25:05 +0800
Subject: [PATCH 2/5] waydroid-helper: add e2fsprogs and unzip to path

---
 pkgs/by-name/wa/waydroid-helper/package.nix | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/pkgs/by-name/wa/waydroid-helper/package.nix b/pkgs/by-name/wa/waydroid-helper/package.nix
index 3a6137c41ff2b3..6df9a186df4a68 100644
--- a/pkgs/by-name/wa/waydroid-helper/package.nix
+++ b/pkgs/by-name/wa/waydroid-helper/package.nix
@@ -16,8 +16,10 @@
   dbus,
   systemd,
   bash,
+  e2fsprogs,
   fakeroot,
   gobject-introspection,
+  unzip,
 }:
 
 python3Packages.buildPythonApplication rec {
@@ -82,7 +84,11 @@ python3Packages.buildPythonApplication rec {
 
   makeWrapperArgs = [
     "\${gappsWrapperArgs[@]}"
-    "--prefix PATH : ${lib.makeBinPath [ fakeroot ]}"
+    "--prefix PATH : ${lib.makeBinPath [
+      e2fsprogs
+      fakeroot
+      unzip
+    ]}"
   ];
 
   postInstallCheck = ''

From 850eeb9cb921dbd16e0236dddfe205fff8593a78 Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Tue, 29 Jul 2025 01:25:36 +0800
Subject: [PATCH 3/5] waydroid-helper: add maintainer

---
 pkgs/by-name/wa/waydroid-helper/package.nix | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/pkgs/by-name/wa/waydroid-helper/package.nix b/pkgs/by-name/wa/waydroid-helper/package.nix
index 6df9a186df4a68..7998d6a6560d6d 100644
--- a/pkgs/by-name/wa/waydroid-helper/package.nix
+++ b/pkgs/by-name/wa/waydroid-helper/package.nix
@@ -104,6 +104,6 @@ python3Packages.buildPythonApplication rec {
     mainProgram = "waydroid-helper";
     platforms = lib.platforms.linux;
     license = with lib.licenses; [ gpl3Plus ];
-    maintainers = with lib.maintainers; [ ];
+    maintainers = with lib.maintainers; [ samlukeyes123 ];
   };
 }

From 958201f3bf65a10c5257e8cac62f64b28fda1927 Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Tue, 29 Jul 2025 22:42:27 +0800
Subject: [PATCH 4/5] waydroid-helper: apply nixfmt

---
 pkgs/by-name/wa/waydroid-helper/package.nix | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/pkgs/by-name/wa/waydroid-helper/package.nix b/pkgs/by-name/wa/waydroid-helper/package.nix
index 7998d6a6560d6d..38c79c1b5af200 100644
--- a/pkgs/by-name/wa/waydroid-helper/package.nix
+++ b/pkgs/by-name/wa/waydroid-helper/package.nix
@@ -84,11 +84,13 @@ python3Packages.buildPythonApplication rec {
 
   makeWrapperArgs = [
     "\${gappsWrapperArgs[@]}"
-    "--prefix PATH : ${lib.makeBinPath [
-      e2fsprogs
-      fakeroot
-      unzip
-    ]}"
+    "--prefix PATH : ${
+      lib.makeBinPath [
+        e2fsprogs
+        fakeroot
+        unzip
+      ]
+    }"
   ];
 
   postInstallCheck = ''

From 43f3acb42eb4ac2164e0c77eb649b47e8058b039 Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Tue, 29 Jul 2025 22:45:31 +0800
Subject: [PATCH 5/5] waydroid-helper: add bindfs and fuse to path

---
 pkgs/by-name/wa/waydroid-helper/package.nix | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/pkgs/by-name/wa/waydroid-helper/package.nix b/pkgs/by-name/wa/waydroid-helper/package.nix
index 38c79c1b5af200..6ec1072316bc62 100644
--- a/pkgs/by-name/wa/waydroid-helper/package.nix
+++ b/pkgs/by-name/wa/waydroid-helper/package.nix
@@ -16,8 +16,10 @@
   dbus,
   systemd,
   bash,
+  bindfs,
   e2fsprogs,
   fakeroot,
+  fuse,
   gobject-introspection,
   unzip,
 }:
@@ -86,8 +88,10 @@ python3Packages.buildPythonApplication rec {
     "\${gappsWrapperArgs[@]}"
     "--prefix PATH : ${
       lib.makeBinPath [
+        bindfs
         e2fsprogs
         fakeroot
+        fuse
         unzip
       ]
     }"
