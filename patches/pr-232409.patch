From f742075d67f4bf4aa637baec8a99b3727977c435 Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Wed, 17 May 2023 19:50:18 +0800
Subject: [PATCH 1/2] qq: 3.1.1-11223 -> 3.1.2-12912

---
 .../networking/instant-messengers/qq/default.nix    | 13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/pkgs/applications/networking/instant-messengers/qq/default.nix b/pkgs/applications/networking/instant-messengers/qq/default.nix
index 9f037845def66..dd0cc9fd0e796 100644
--- a/pkgs/applications/networking/instant-messengers/qq/default.nix
+++ b/pkgs/applications/networking/instant-messengers/qq/default.nix
@@ -22,15 +22,16 @@
 }:
 
 let
-  version = "3.1.1-11223";
+  version = "3.1.2-12912";
+  _hash = "80d33f88";
   srcs = {
     x86_64-linux = fetchurl {
-      url = "https://dldir1.qq.com/qqfile/qq/QQNT/2355235c/linuxqq_${version}_amd64.deb";
-      sha256 = "sha256-TBgQ7zV+juB3KSgIIXuvxnYmvnnM/1/wU0EkiopIqvY=";
+      url = "https://dldir1.qq.com/qqfile/qq/QQNT/${_hash}/linuxqq_${version}_amd64.deb";
+      hash = "sha256-F+zIHqYWKiCHYNJZ5hRw0rzltizjuqhVxbpzQGagoZ0=";
     };
     aarch64-linux = fetchurl {
-      url = "https://dldir1.qq.com/qqfile/qq/QQNT/2355235c/linuxqq_${version}_arm64.deb";
-      sha256 = "sha256-1ba/IA/+X/s7jUtIhh3OsBHU7MPggGrASsBPx8euBBs=";
+      url = "https://dldir1.qq.com/qqfile/qq/QQNT/${_hash}/linuxqq_${version}_arm64.deb";
+      hash = "sha256-5n4T0mlfEh9/84wUYiH437R95Qz6/SKDq/AK6baiW24=";
     };
   };
   src = srcs.${stdenv.hostPlatform.system} or (throw "Unsupported system: ${stdenv.hostPlatform.system}");
@@ -39,8 +40,6 @@ stdenv.mkDerivation {
   pname = "qq";
   inherit version src;
 
-  unpackCmd = "dpkg-deb -x $curSrc source";
-
   nativeBuildInputs = [
     autoPatchelfHook
     wrapGAppsHook

From a8ef21e2ef6f9bbbb78ab6533ec1b06cd82362c6 Mon Sep 17 00:00:00 2001
From: SamLukeYes <samlukeyes123@gmail.com>
Date: Wed, 17 May 2023 21:44:10 +0800
Subject: [PATCH 2/2] qq: use libayatana-appindicator

---
 .../networking/instant-messengers/qq/default.nix           | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/pkgs/applications/networking/instant-messengers/qq/default.nix b/pkgs/applications/networking/instant-messengers/qq/default.nix
index dd0cc9fd0e796..e47a5349ed690 100644
--- a/pkgs/applications/networking/instant-messengers/qq/default.nix
+++ b/pkgs/applications/networking/instant-messengers/qq/default.nix
@@ -6,7 +6,7 @@
 , glib
 , gtk3
 , lib
-, libappindicator
+, libayatana-appindicator
 , libdrm
 , libgcrypt
 , libkrb5
@@ -62,7 +62,6 @@ stdenv.mkDerivation {
   ];
 
   runtimeDependencies = map lib.getLib [
-    libappindicator
     systemd
   ];
 
@@ -80,6 +79,10 @@ stdenv.mkDerivation {
     # Remove bundled libraries
     rm -r $out/opt/QQ/resources/app/sharp-lib
 
+    # https://github.com/microcai/gentoo-zh/commit/06ad5e702327adfe5604c276635ae8a373f7d29e
+    ln -s ${libayatana-appindicator}/lib/libayatana-appindicator3.so \
+      $out/opt/QQ/libappindicator3.so
+
     runHook postInstall
   '';
 
